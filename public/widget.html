<!doctype html>
<html lang="ru">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>–í–∞—à –ì–ª–∞–≤–ë—É—Ö ‚Äî —á–∞—Ç</title>
  <style>
    body{margin:0;background:#f7f8fb;font:16px/1.5 system-ui,-apple-system,Segoe UI,Roboto,Arial;color:#111827}
    .wrap{max-width:860px;margin:0 auto;padding:16px}
    .title{font-weight:700;font-size:18px;color:#1E3A8A}
    .note{font-size:13px;color:#6B7280;margin:6px 0 12px}
    .note a{color:#0ea5a5;text-decoration:none}
    .panel{background:#fff;border:1px solid #e5e7eb;border-radius:14px;padding:14px;height:62vh;overflow:auto}
    .composer{display:flex;gap:10px;margin-top:10px}
    textarea{flex:1;resize:vertical;border:1px solid #e5e7eb;border-radius:10px;padding:10px;font:inherit}
    button{padding:10px 16px;border:0;border-radius:10px;background:#10B981;color:#fff;font-weight:700;cursor:pointer}
    button:disabled{opacity:.6;cursor:default}
    .msg{display:flex;gap:10px;margin-bottom:10px}
    .bubble{max-width:76%;padding:10px 12px;border-radius:12px;border:1px solid #e5e7eb;background:#fff}
    .me .bubble{background:#DCFCE7;border-color:#86EFAC;margin-left:auto}
    .ai .bubble{background:#fff}
  </style>
</head>
<body>
  <div class="wrap">
    <div class="title">–í–∞—à –ì–ª–∞–≤–ë—É—Ö ‚Äî –æ–Ω–ª–∞–π–Ω –ø–æ–º–æ—â–Ω–∏–∫ 24/7</div>
    <div class="note">üîí –ù–µ –æ—Ç–ø—Ä–∞–≤–ª—è–π—Ç–µ –ø–µ—Ä—Å–æ–Ω–∞–ª—å–Ω—ã–µ –¥–∞–Ω–Ω—ã–µ. –î–ª—è –∑–∞—â–∏—Ç—ã –∏—Å–ø–æ–ª—å–∑—É–π—Ç–µ <a href="/anonimize/" target="_blank">–æ–±–µ–∑–ª–∏—á–∏–≤–∞—Ç–µ–ª—å</a>.</div>

    <div id="chat" class="panel"></div>

    <form id="form" class="composer">
      <textarea id="input" rows="2" placeholder="–ù–∞–ø–∏—à–∏—Ç–µ –≤–æ–ø—Ä–æ—Å –ø–æ –Ω–∞–ª–æ–≥–∞–º, –æ—Ç—á—ë—Ç–Ω–æ—Å—Ç–∏, —É—á—ë—Ç—É‚Ä¶"></textarea>
      <button id="send" type="submit">–û—Ç–ø—Ä–∞–≤–∏—Ç—å</button>
    </form>
  </div>

  <script>
    const chat = document.getElementById('chat');
    const form = document.getElementById('form');
    const input = document.getElementById('input');
    const sendBtn = document.getElementById('send');

    function add(role, text) {
      const row = document.createElement('div');
      row.className = 'msg ' + (role === 'user' ? 'me' : 'ai');
      const b = document.createElement('div');
      b.className = 'bubble';
      b.textContent = text;
      row.appendChild(b);
      chat.appendChild(row);
      chat.scrollTop = chat.scrollHeight;
      return b;
    }

    form.addEventListener('submit', async (e) => {
      e.preventDefault();
      const q = (input.value || '').trim();
      if (!q) return;

      add('user', q);
      input.value = '';
      sendBtn.disabled = true;

      const a = add('assistant', '‚Ä¶');

      try {
        const resp = await fetch('/api/chat', {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify({ messages: [{ role: 'user', content: q }] })
        });
        if (!resp.ok || !resp.body) throw new Error('No stream');

        const reader = resp.body.getReader();
        const decoder = new TextDecoder('utf-8');
        let acc = '';

        while (true) {
          const { done, value } = await reader.read();
          if (done) break;
          const chunk = decoder.decode(value, { stream: true });
          const parts = (acc + chunk).split('\n\n');
          acc = parts.pop() || '';
          for (const p of parts) {
            const line = p.trim();
            if (!line.startsWith('data:')) continue;
            const json = line.slice(5).trim();
            try {
              const { delta, done, error } = JSON.parse(json);
              if (error) { a.textContent = '–ü–µ—Ä–µ–≥—Ä—É–∑–∫–∞ –∏–ª–∏ –æ—à–∏–±–∫–∞. –ü–æ–ø—Ä–æ–±—É–π—Ç–µ –µ—â—ë —Ä–∞–∑.'; break; }
              if (done) break;
              if (delta) a.textContent += delta;
            } catch {}
          }
          chat.scrollTop = chat.scrollHeight;
        }
      } catch (err) {
        a.textContent = '–û—à–∏–±–∫–∞ —Å–æ–µ–¥–∏–Ω–µ–Ω–∏—è. –ü–æ–≤—Ç–æ—Ä–∏—Ç–µ –ø–æ–ø—ã—Ç–∫—É –ø–æ–∑–∂–µ.';
      } finally {
        sendBtn.disabled = false;
      }
    });
  </script>
</body>
</html>
