<!doctype html>
<html lang="ru">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>–í–∞—à –ì–ª–∞–≤–ë—É—Ö ‚Äî —á–∞—Ç</title>
  <style>
    body{margin:0;background:#f7f8fb;font:16px/1.5 system-ui,-apple-system,Segoe UI,Roboto,Arial;color:#111827}
    .wrap{max-width:860px;margin:0 auto;padding:16px}
    .title{font-weight:700;font-size:18px;color:#1E3A8A}
    .note{font-size:13px;color:#6B7280;margin:6px 0 12px}
    .note a{color:#0ea5a5;text-decoration:none}
    .panel{background:#fff;border:1px solid #e5e7eb;border-radius:14px;padding:14px;height:62vh;overflow:auto}
    .composer{display:flex;gap:10px;margin-top:10px}
    textarea{flex:1;resize:vertical;border:1px solid #e5e7eb;border-radius:10px;padding:10px;font:inherit}
    button{padding:10px 16px;border:0;border-radius:10px;background:#10B981;color:#fff;font-weight:700;cursor:pointer}
    button:disabled{opacity:.6;cursor:default}
    .msg{display:flex;gap:10px;margin-bottom:10px}
    .bubble{max-width:76%;padding:10px 12px;border-radius:12px;border:1px solid #e5e7eb;background:#fff}
    .me .bubble{background:#DCFCE7;border-color:#86EFAC;margin-left:auto}
    .ai .bubble{background:#fff}
  </style>
</head>
<body>
  <div class="wrap">
    <div class="title">–í–∞—à –ì–ª–∞–≤–ë—É—Ö ‚Äî –æ–Ω–ª–∞–π–Ω –ø–æ–º–æ—â–Ω–∏–∫ 24/7</div>
    <div class="note">üîí –ù–µ –æ—Ç–ø—Ä–∞–≤–ª—è–π—Ç–µ –ø–µ—Ä—Å–æ–Ω–∞–ª—å–Ω—ã–µ –¥–∞–Ω–Ω—ã–µ. –î–ª—è –∑–∞—â–∏—Ç—ã –∏—Å–ø–æ–ª—å–∑—É–π—Ç–µ <a href="/anonimize/" target="_blank">–æ–±–µ–∑–ª–∏—á–∏–≤–∞—Ç–µ–ª—å</a>.</div>

    <div id="chat" class="panel"></div>

    <form id="form" class="composer">
  <input id="file" type="file" accept=".pdf,.docx,.txt" style="max-width:220px">
  <textarea id="input" rows="2" placeholder="–ù–∞–ø–∏—à–∏—Ç–µ –≤–æ–ø—Ä–æ—Å –ø–æ –Ω–∞–ª–æ–≥–∞–º, –æ—Ç—á—ë—Ç–Ω–æ—Å—Ç–∏, —É—á—ë—Ç—É‚Ä¶"></textarea>
  <button id="send" type="submit">–û—Ç–ø—Ä–∞–≤–∏—Ç—å</button>
</form>
<div id="attachInfo" style="font-size:12px;color:#6B7280;margin-top:6px"></div>

  <script>
  let attachmentId = null;
  const fileEl = document.getElementById('file');
  const attachInfo = document.getElementById('attachInfo');

  fileEl.addEventListener('change', async () => {
    const f = fileEl.files[0];
    if (!f) return;
    attachInfo.textContent = '–ó–∞–≥—Ä—É–∑–∫–∞‚Ä¶';
    try {
      const fd = new FormData();
      fd.append('file', f);
      const token = localStorage.getItem('gb_token') || '';
const resp = await fetch('/api/upload', {
  method: 'POST',
  headers: { 'x-gb-token': token },
  body: fd
});
  const data = await resp.json();
      if (!resp.ok || data.error) throw new Error(data.error || '–û—à–∏–±–∫–∞ –∑–∞–≥—Ä—É–∑–∫–∏');

      attachmentId = data.id;
      attachInfo.textContent = `–ü—Ä–∏–∫—Ä–µ–ø–ª—ë–Ω: ${data.name} (—Ç–µ–∫—Å—Ç ${data.length} —Å–∏–º–≤–æ–ª–æ–≤)`;
    } catch (e) {
      attachmentId = null;
      attachInfo.textContent = '–ù–µ —É–¥–∞–ª–æ—Å—å –∑–∞–≥—Ä—É–∑–∏—Ç—å —Ñ–∞–π–ª. –£–±–µ–¥–∏—Ç–µ—Å—å, —á—Ç–æ —Ñ–æ—Ä–º–∞—Ç PDF/DOCX/TXT –∏ —Ä–∞–∑–º–µ—Ä –¥–æ 10 –ú–ë.';
      fileEl.value = '';
    }
  });
    const chat = document.getElementById('chat');
    const form = document.getElementById('form');
    const input = document.getElementById('input');
    const sendBtn = document.getElementById('send');

    function add(role, text) {
      const row = document.createElement('div');
      row.className = 'msg ' + (role === 'user' ? 'me' : 'ai');
      const b = document.createElement('div');
      b.className = 'bubble';
      b.textContent = text;
      row.appendChild(b);
      chat.appendChild(row);
      chat.scrollTop = chat.scrollHeight;
      return b;
    }
// –ï—Å–ª–∏ –Ω–µ—Ç —Ç–æ–∫–µ–Ω–∞ ‚Äî –ø—Ä—è—á–µ–º –∏–Ω—Ç–µ—Ä—Ñ–µ–π—Å –∏ –ø—Ä–µ–¥–ª–∞–≥–∞–µ–º —Ä–µ–≥–∏—Å—Ç—Ä–∞—Ü–∏—é
(function gate() {
  const token = localStorage.getItem('gb_token') || '';
  if (!token) {
    const wrap = document.querySelector('.wrap');
    wrap.innerHTML = `
      <div class="title">–î–æ—Å—Ç—É–ø —Ç–æ–ª—å–∫–æ –¥–ª—è –∑–∞—Ä–µ–≥–∏—Å—Ç—Ä–∏—Ä–æ–≤–∞–Ω–Ω—ã—Ö</div>
      <div class="note">–ß—Ç–æ–±—ã –æ—Ç–∫—Ä—ã—Ç—å —á–∞—Ç –æ–Ω–ª–∞–π–Ω-–ø–æ–º–æ—â–Ω–∏–∫–∞, –ø—Ä–æ–π–¥–∏—Ç–µ —Ä–µ–≥–∏—Å—Ç—Ä–∞—Ü–∏—é –∏ –ø–æ–¥—Ç–≤–µ—Ä–¥–∏—Ç–µ e-mail.</div>
      <p><a href="/register" style="display:inline-block;padding:10px 16px;border-radius:10px;background:#10B981;color:#fff;text-decoration:none;font-weight:700">–ó–∞—Ä–µ–≥–∏—Å—Ç—Ä–∏—Ä–æ–≤–∞—Ç—å—Å—è</a></p>
    `;
  }
})();
    
    form.addEventListener('submit', async (e) => {
      e.preventDefault();
      const q = (input.value || '').trim();
      if (!q) return;

      add('user', q);
      input.value = '';
      sendBtn.disabled = true;

      const a = add('assistant', '‚Ä¶');
const token = localStorage.getItem('gb_token') || '';
const resp = await fetch('/api/chat_plus', { ... })
  method: 'POST',
  headers: { 
    'Content-Type': 'application/json',
    'x-gb-token': token   // <-- –¥–æ–±–∞–≤–∏–ª–∏ —Ç–æ–∫–µ–Ω –≤ –∑–∞–≥–æ–ª–æ–≤–æ–∫ (–Ω–∞ —Å–ª–µ–¥—É—é—â–µ–º —à–∞–≥–µ –Ω–∞—á–Ω–µ–º –ø—Ä–æ–≤–µ—Ä—è—Ç—å)
  },
  body: JSON.stringify({ messages: [{ role: 'user', content: q }], attachmentId })
});

      try {
        const resp = await fetch('/api/chat', {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify({ 
           messages: [{ role: 'user', content: q }],
           attachmentId
          })
        if (!resp.ok || !resp.body) throw new Error('No stream');

        const reader = resp.body.getReader();
        const decoder = new TextDecoder('utf-8');
        let acc = '';

        while (true) {
          const { done, value } = await reader.read();
          if (done) break;
          const chunk = decoder.decode(value, { stream: true });
          const parts = (acc + chunk).split('\n\n');
          acc = parts.pop() || '';
          for (const p of parts) {
            const line = p.trim();
            if (!line.startsWith('data:')) continue;
            const json = line.slice(5).trim();
            try {
              const { delta, done, error } = JSON.parse(json);
              if (error) { a.textContent = '–ü–µ—Ä–µ–≥—Ä—É–∑–∫–∞ –∏–ª–∏ –æ—à–∏–±–∫–∞. –ü–æ–ø—Ä–æ–±—É–π—Ç–µ –µ—â—ë —Ä–∞–∑.'; break; }
              if (done) break;
              if (delta) a.textContent += delta;
            } catch {}
          }
          chat.scrollTop = chat.scrollHeight;
        }
      } catch (err) {
        a.textContent = '–û—à–∏–±–∫–∞ —Å–æ–µ–¥–∏–Ω–µ–Ω–∏—è. –ü–æ–≤—Ç–æ—Ä–∏—Ç–µ –ø–æ–ø—ã—Ç–∫—É –ø–æ–∑–∂–µ.';
      } finally {
        sendBtn.disabled = false;
      }
    });
  </script>
</body>
</html>
