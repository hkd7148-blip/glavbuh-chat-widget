<!doctype html>
<html lang="ru">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Обезличивание документов</title>
  <style>
    body{margin:0;background:#f7f8fb;font:16px/1.5 system-ui,-apple-system,Segoe UI,Roboto,Arial;color:#111827}
    .wrap{max-width:860px;margin:0 auto;padding:16px}
    h1{font-size:20px;margin:0 0 6px;color:#1E3A8A}
    .note{font-size:13px;color:#6B7280;margin:0 0 12px}
    .card{background:#fff;border:1px solid #e5e7eb;border-radius:14px;padding:16px}
    .row{display:flex;gap:10px;flex-wrap:wrap;align-items:center}
    input[type=file]{padding:8px;border:1px solid #e5e7eb;border-radius:10px;background:#fff}
    button{padding:10px 16px;border:0;border-radius:10px;background:#10B981;color:#fff;font-weight:700;cursor:pointer}
    .muted{font-size:12px;color:#6B7280}
    .ok{color:#065f46}
    .err{color:#b91c1c}
    .hint{margin-top:10px;font-size:13px;color:#374151}
    .link{color:#0ea5a5;text-decoration:none}
  </style>
</head>
<body>
  <div class="wrap">
    <h1>Обезличивание документов</h1>
    <div class="note">Загрузите PDF, DOCX или TXT — мы изъём текст, автоматически маскируем персональные и платёжные данные и отдадим вам .txt для скачивания.</div>

    <div class="card">
      <div class="row">
        <input id="file" type="file" accept=".pdf,.docx,.txt">
        <button id="go">Обезличить и скачать</button>
      </div>
      <div id="status" class="hint"></div>
      <div class="hint">После обезличивания вы можете прикрепить полученный .txt в <a class="link" href="/widget" target="_blank">чат-помощник</a>.</div>
      <div class="muted" style="margin-top:10px">
        ⚠️ Если ваш PDF — скан (картинка), текст не извлечётся. Сначала распознайте его в PDF (OCR) и попробуйте снова.
      </div>
    </div>
  </div>

  <script>
    const fileEl = document.getElementById('file');
    const goBtn  = document.getElementById('go');
    const statusEl = document.getElementById('status');

    goBtn.addEventListener('click', async () => {
      const f = fileEl.files[0];
      if (!f) {
        statusEl.textContent = 'Выберите файл.';
        statusEl.className = 'hint err';
        return;
      }
      statusEl.textContent = 'Обработка…';
      statusEl.className = 'hint';

      try {
        const fd = new FormData();
        fd.append('file', f);
        const resp = await fetch('/api/anon', { method: 'POST', body: fd });

        if (!resp.ok) {
          const data = await resp.json().catch(()=>({}));
          throw new Error(data.error || 'Ошибка сервера');
        }

        const blob = await resp.blob();
        const url = URL.createObjectURL(blob);

        // Вытащим имя из заголовка
        const cd = resp.headers.get('Content-Disposition') || '';
        const m = cd.match(/filename="([^"]+)"/);
        const fname = m ? m[1] : (f.name.replace(/\.[^.]+$/, '') + '-anon.txt');

        const a = document.createElement('a');
        a.href = url;
        a.download = fname;
        document.body.appendChild(a);
        a.click();
        a.remove();
        URL.revokeObjectURL(url);

        statusEl.textContent = 'Готово. Файл скачан.';
        statusEl.className = 'hint ok';
      } catch (e) {
        statusEl.textContent = 'Ошибка: ' + e.message;
        statusEl.className = 'hint err';
      }
    });
  </script>
</body>
</html>
