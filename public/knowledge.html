<!doctype html>
<html lang="ru">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>База знаний — админ</title>
  <script src="https://cdn.tailwindcss.com"></script>
  <link rel="preconnect" href="https://fonts.googleapis.com">
  <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
  <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;600;700&display=swap" rel="stylesheet">
  <style>
    :root { --accent:#0ea5e9; }
    body{ font-family: Inter, system-ui, -apple-system, Segoe UI, Roboto, Arial, sans-serif; }
    .card{ @apply bg-white border border-slate-200 rounded-2xl shadow-sm; }
    .badge{ @apply inline-flex items-center px-2 py-0.5 rounded text-xs font-semibold; }
  </style>
</head>
<body class="bg-slate-50 text-slate-900">
  <div class="max-w-6xl mx-auto px-4 py-6">
    <!-- Header -->
    <header class="mb-6 flex items-center justify-between">
      <div>
        <h1 class="text-2xl font-bold text-slate-900">База знаний — админ</h1>
        <p class="text-slate-500 text-sm">Загрузка документов, поиск, статистика и управление</p>
      </div>
      <div class="flex items-center gap-3">
        <span id="ragStatusBadge" class="badge bg-slate-100 text-slate-600">Статус: —</span>
        <button id="refreshAll" class="px-3 py-2 rounded-xl bg-sky-600 text-white font-semibold hover:bg-sky-700">Обновить всё</button>
      </div>
    </header>

    <!-- Token bar -->
    <section class="card p-4 mb-6">
      <div class="flex flex-col md:flex-row md:items-end gap-3">
        <div class="grow">
          <label class="block text-sm font-semibold mb-1">Админ-токен</label>
          <input id="adminToken" type="password" class="w-full rounded-xl border-slate-300 focus:border-sky-500 focus:ring-sky-500" placeholder="вставьте токен из админки" />
          <p class="text-xs text-slate-500 mt-1">Токен сохраняется локально в браузере и передаётся в заголовке <code>x-gb-token</code>.</p>
        </div>
        <button id="saveToken" class="px-4 py-2 rounded-xl bg-emerald-600 text-white font-semibold hover:bg-emerald-700">Сохранить токен</button>
        <button id="clearToken" class="px-3 py-2 rounded-xl border border-slate-200 font-semibold hover:bg-slate-100">Очистить</button>
      </div>
    </section>

    <!-- Grid: upload + search -->
    <div class="grid grid-cols-1 lg:grid-cols-2 gap-6">
      <!-- Upload -->
      <section class="card p-5">
        <h2 class="text-lg font-semibold mb-3">Загрузка документа</h2>
        <form id="uploadForm" class="space-y-3">
          <div>
            <label class="block text-sm font-medium mb-1">Файл (PDF / DOCX / TXT)</label>
            <input id="fileInput" type="file" accept=".pdf,.docx,.txt" class="block w-full text-sm" required />
          </div>
          <div>
            <label class="block text-sm font-medium mb-1">Заголовок</label>
            <input id="titleInput" type="text" class="w-full rounded-xl border-slate-300 focus:border-sky-500 focus:ring-sky-500" placeholder="например, Письмо ФНС от ..." />
          </div>
          <div>
            <label class="block text-sm font-medium mb-1">Описание</label>
            <textarea id="descInput" rows="3" class="w-full rounded-xl border-slate-300 focus:border-sky-500 focus:ring-sky-500" placeholder="краткое описание"></textarea>
          </div>
          <div class="flex items-center gap-3">
            <button class="px-4 py-2 rounded-xl bg-sky-600 text-white font-semibold hover:bg-sky-700" type="submit">Загрузить</button>
            <span id="uploadNote" class="text-sm text-slate-500"></span>
          </div>
          <p class="text-xs text-slate-500">Файл обрабатывается на сервере: извлечение текста → чанкинг → эмбеддинги → сохранение.</p>
        </form>
      </section>

      <!-- Search -->
      <section class="card p-5">
        <h2 class="text-lg font-semibold mb-3">Поиск по базе знаний</h2>
        <form id="searchForm" class="space-y-3">
          <div>
            <label class="block text-sm font-medium mb-1">Запрос</label>
            <input id="searchQuery" type="text" class="w-full rounded-xl border-slate-300 focus:border-sky-500 focus:ring-sky-500" placeholder="например: вычеты по НДС при импорте" required />
          </div>
          <div class="flex items-center gap-3">
            <input id="searchTopK" type="number" min="1" max="10" value="5" class="w-24 rounded-xl border-slate-300" />
            <button class="px-4 py-2 rounded-xl bg-sky-600 text-white font-semibold hover:bg-sky-700" type="submit">Искать</button>
            <span id="searchNote" class="text-sm text-slate-500"></span>
          </div>
        </form>
        <div id="searchResults" class="mt-4 space-y-3"></div>
      </section>
    </div>

    <!-- Stats -->
    <section class="card p-5 mt-6">
      <div class="flex items-center justify-between mb-3">
        <h2 class="text-lg font-semibold">Статистика базы знаний</h2>
        <button id="refreshStats" class="px-3 py-2 rounded-xl border border-slate-200 font-semibold hover:bg-slate-100">Обновить</button>
      </div>
      <div id="stats" class="grid grid-cols-2 md:grid-cols-4 gap-3 text-sm">
        <div class="p-3 rounded-xl bg-slate-50">
          <div class="text-slate-500">Документов</div>
          <div id="statDocs" class="text-xl font-bold">—</div>
        </div>
        <div class="p-3 rounded-xl bg-slate-50">
          <div class="text-slate-500">Чанков</div>
          <div id="statChunks" class="text-xl font-bold">—</div>
        </div>
        <div class="p-3 rounded-xl bg-slate-50">
          <div class="text-slate-500">Общий размер</div>
          <div id="statSize" class="text-xl font-bold">—</div>
        </div>
        <div class="p-3 rounded-xl bg-slate-50">
          <div class="text-slate-500">Средн. чанков/док.</div>
          <div id="statAvg" class="text-xl font-bold">—</div>
        </div>
      </div>
    </section>

    <!-- Documents list -->
    <section class="card p-5 mt-6">
      <div class="flex items-center justify-between mb-3">
        <h2 class="text-lg font-semibold">Документы</h2>
        <button id="refreshList" class="px-3 py-2 rounded-xl border border-slate-200 font-semibold hover:bg-slate-100">Обновить список</button>
      </div>
      <div class="overflow-x-auto">
        <table class="min-w-full text-sm">
          <thead>
            <tr class="text-left text-slate-500">
              <th class="py-2 pr-3">Название</th>
              <th class="py-2 pr-3">Оригинал</th>
              <th class="py-2 pr-3">Загружен</th>
              <th class="py-2 pr-3">Чанков</th>
              <th class="py-2 pr-3">Размер</th>
              <th class="py-2 pr-3">Действия</th>
            </tr>
          </thead>
          <tbody id="docRows"></tbody>
        </table>
      </div>
    </section>

    <!-- Footer -->
    <footer class="mt-10 text-center text-xs text-slate-400">
      © ГлавБух — knowledge admin page
    </footer>
  </div>

<script>
  const $ = (sel, root=document) => root.querySelector(sel);
  const $$ = (sel, root=document) => Array.from(root.querySelectorAll(sel));

  const state = {
    token: localStorage.getItem('gb_admin_token') || ''
  };

  const endpoints = {
    ragStatus: '/api/rag/status', // требует user auth, но мы будем слать админ-токен
    upload: '/api/knowledge/upload',
    list: '/api/knowledge/list',
    stats: '/api/knowledge/stats',
    search: '/api/knowledge/search',
    del: (docId) => `/api/knowledge/${encodeURIComponent(docId)}`
  };

  // UI init
  $('#adminToken').value = state.token;

  function hdr() {
    const h = { };
    if (state.token) h['x-gb-token'] = state.token;
    return h;
  }

  async function fetchJSON(url, options={}) {
    const resp = await fetch(url, {
      ...options,
      headers: { 'Accept':'application/json', ...(options.headers||{}), ...hdr() }
    });
    if (!resp.ok) {
      const t = await resp.text().catch(()=> '');
      throw new Error(`HTTP ${resp.status}: ${t || resp.statusText}`);
    }
    return resp.json();
  }

  async function fetchMultipart(url, formData) {
    const resp = await fetch(url, {
      method: 'POST',
      body: formData,
      headers: { ...hdr() }
    });
    if (!resp.ok) {
      const t = await resp.text().catch(()=> '');
      throw new Error(`HTTP ${resp.status}: ${t || resp.statusText}`);
    }
    return resp.json();
  }

  function fmtBytes(bytes = 0) {
    if (!bytes) return '—';
    const units = ['Б','КБ','МБ','ГБ'];
    let i = 0; let n = bytes;
    while (n >= 1024 && i < units.length-1) { n/=1024; i++; }
    return `${n.toFixed(n<10?1:0)} ${units[i]}`;
  }

  function tsToLocal(ts) {
    if (!ts) return '—';
    const d = new Date(ts);
    return isNaN(d) ? '—' : d.toLocaleString();
  }

  // RAG status
  async function loadRagStatus() {
    try {
      const data = await fetchJSON(endpoints.ragStatus);
      const txt = data.enabled ? `Активна • ${data.documentsCount} док.` : 'Пуста';
      const badge = $('#ragStatusBadge');
      badge.textContent = `Статус: ${txt}`;
      badge.className = 'badge ' + (data.enabled ? 'bg-emerald-50 text-emerald-700' : 'bg-slate-100 text-slate-600');
    } catch (e) {
      const badge = $('#ragStatusBadge');
      badge.textContent = 'Статус: ошибка';
      badge.className = 'badge bg-rose-50 text-rose-700';
      console.error(e);
    }
  }

  // Stats
  async function loadStats() {
    try {
      const s = await fetchJSON(endpoints.stats);
      $('#statDocs').textContent = s.documents;
      $('#statChunks').textContent = s.chunks;
      $('#statSize').textContent = fmtBytes(s.totalFileSize);
      $('#statAvg').textContent = s.averageChunksPerDoc;
    } catch (e) {
      console.error(e);
    }
  }

  // List
  async function loadList() {
    const tbody = $('#docRows');
    tbody.innerHTML = '<tr><td colspan="6" class="py-6 text-center text-slate-500">Загрузка...</td></tr>';
    try {
      const data = await fetchJSON(endpoints.list);
      if (!data.documents?.length) {
        tbody.innerHTML = '<tr><td colspan="6" class="py-6 text-center text-slate-500">Пока нет документов</td></tr>';
        return;
      }
      tbody.innerHTML = '';
      for (const doc of data.documents) {
        const tr = document.createElement('tr');
        tr.className = 'border-t border-slate-100 hover:bg-slate-50';
        tr.innerHTML = `
          <td class="py-2 pr-3">
            <div class="font-semibold">${escapeHtml(doc.title||'Без названия')}</div>
            <div class="text-xs text-slate-500">ID: ${doc.id}</div>
          </td>
          <td class="py-2 pr-3">${escapeHtml(doc.originalName||'—')}</td>
          <td class="py-2 pr-3">${escapeHtml(doc.uploadedAt||'—')}</td>
          <td class="py-2 pr-3">${doc.chunks ?? '—'}</td>
          <td class="py-2 pr-3">${fmtBytes(doc.fileSize)}</td>
          <td class="py-2 pr-3">
            <button data-id="${doc.id}" class="delBtn px-3 py-1.5 rounded-lg bg-rose-600 text-white text-xs font-semibold hover:bg-rose-700">Удалить</button>
          </td>`;
        tbody.appendChild(tr);
      }
      $$('.delBtn', tbody).forEach(btn => btn.addEventListener('click', onDeleteDoc));
    } catch (e) {
      console.error(e);
      tbody.innerHTML = `<tr><td colspan="6" class="py-6 text-center text-rose-600">Ошибка: ${escapeHtml(e.message)}</td></tr>`;
    }
  }

  async function onDeleteDoc(ev) {
    const id = ev.currentTarget.getAttribute('data-id');
    if (!id) return;
    if (!confirm('Удалить документ и все его чанки?')) return;
    try {
      const resp = await fetch(endpoints.del(id), { method:'DELETE', headers: { ...hdr() } });
      if (!resp.ok) throw new Error(await resp.text());
      await loadList();
      await loadStats();
    } catch (e) {
      alert('Ошибка удаления: ' + e.message);
    }
  }

  // Upload
  $('#uploadForm').addEventListener('submit', async (e) => {
    e.preventDefault();
    const file = $('#fileInput').files[0];
    if (!file) { alert('Выберите файл'); return; }
    const fd = new FormData();
    fd.append('file', file);
    const t = $('#titleInput').value.trim();
    const d = $('#descInput').value.trim();
    if (t) fd.append('title', t);
    if (d) fd.append('description', d);

    $('#uploadNote').textContent = 'Загрузка... (это может занять время)';
    try {
      const res = await fetchMultipart(endpoints.upload, fd);
      $('#uploadNote').textContent = `Готово: ${res.title || 'документ'} • чанков: ${res.chunks}`;
      $('#uploadForm').reset();
      await loadList();
      await loadStats();
      await loadRagStatus();
    } catch (e2) {
      console.error(e2);
      $('#uploadNote').textContent = 'Ошибка: ' + e2.message;
    }
  });

  // Search
  $('#searchForm').addEventListener('submit', async (e) => {
    e.preventDefault();
    const q = $('#searchQuery').value.trim();
    const k = Number($('#searchTopK').value || 5);
    if (!q) return;
    $('#searchNote').textContent = 'Ищем...';
    $('#searchResults').innerHTML = '';
    try {
      const res = await fetchJSON(endpoints.search, {
        method: 'POST',
        headers: { 'Content-Type':'application/json' },
        body: JSON.stringify({ query: q, topK: k })
      });
      $('#searchNote').textContent = `Найдено: ${res.results}`;
      renderSearch(res.data || []);
    } catch (e2) {
      console.error(e2);
      $('#searchNote').textContent = 'Ошибка: ' + e2.message;
    }
  });

  function renderSearch(items) {
    const box = $('#searchResults');
    if (!items.length) {
      box.innerHTML = '<div class="text-slate-500">Ничего не найдено</div>';
      return;
    }
    box.innerHTML = '';
    for (const it of items) {
      const el = document.createElement('div');
      el.className = 'p-3 rounded-xl border border-slate-200 bg-white';
      el.innerHTML = `
        <div class="flex items-center justify-between">
          <div class="font-semibold">${escapeHtml(it.document || '—')}</div>
          <div class="text-xs text-slate-500">similarity: ${(it.similarity ?? 0).toFixed(3)}</div>
        </div>
        <div class="mt-1 text-sm text-slate-700 whitespace-pre-wrap">${escapeHtml(it.text || '')}</div>
        <div class="mt-1 text-xs text-slate-500">${escapeHtml(JSON.stringify(it.metadata || {}))}</div>
      `;
      box.appendChild(el);
    }
  }

  // Token controls
  $('#saveToken').addEventListener('click', () => {
    const v = $('#adminToken').value.trim();
    state.token = v;
    localStorage.setItem('gb_admin_token', v);
    toast('Токен сохранён');
  });
  $('#clearToken').addEventListener('click', () => {
    state.token = '';
    localStorage.removeItem('gb_admin_token');
    $('#adminToken').value = '';
    toast('Токен очищен');
  });

  // Refresh buttons
  $('#refreshAll').addEventListener('click', () => { loadAll(); });
  $('#refreshStats').addEventListener('click', () => { loadStats(); });
  $('#refreshList').addEventListener('click', () => { loadList(); });

  function toast(msg) {
    const t = document.createElement('div');
    t.className = 'fixed bottom-4 left-1/2 -translate-x-1/2 bg-slate-900 text-white px-4 py-2 rounded-xl shadow-lg text-sm';
    t.textContent = msg;
    document.body.appendChild(t);
    setTimeout(()=>{ t.remove(); }, 1800);
  }

  function escapeHtml(s='') {
    return s.replace(/[&<>"']/g, (c) => ({'&':'&amp;','<':'&lt;','>':'&gt;','"':'&quot;','\'':'&#39;'}[c]));
  }

  async function loadAll() {
    await loadRagStatus();
    await loadStats();
    await loadList();
  }

  // initial
  loadAll();
</script>
</body>
</html>
